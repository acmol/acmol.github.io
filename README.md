# For Gitlab

## 当前流程

研发完成后，提交者将MR发给Maintainer进行合入，这时，同步在执行流水线。

合入者需要进行以下操作：

1. 进行Review，如果有问题，反馈给提交者修改。可能进行多轮。
2. 等待流水线完成，如果流水线有问题，需要反馈给提交者修复，后续又要等一轮流水线。
3. 最后检查流水线和结果正确性，正确才合入。

## 当前流程中的问题

当前流程中，合入人的职责过重过多，导致了以下问题：

1. Review质量下降
因为待review任务过重，不得不将review时间缩短，导致review质量下降。
虽然有手段可以要求提交者先找别人Review，再找Maintainer合入，但因为最后还是要找Maintainer合入，经常执行到最后许多人都会直接把未经Review的任务发给Maintainer进行Review，使得最终Review任务还是在Maintainer头上。

2. 合入效率下降
流水线结果的检查的职责也在Maintainer头上，Maintainer经常需要等一段时间的流水线结果，容易打乱工作节奏，也经常为了等流水线而容易忘记及时合入。导致合入效率下降

3. 容易诱发强合
为了避免忘记合入，Maintainer容易会对MR进行Review后进行粗略判断，如果粗判断『不可能』影响流水线，就直接强合。这导致了许多问题 block性的问题。 
甚至因为现在合入权限需要Maintainer，而强合权限也是Maintainer，拥有合入权限的人也拥有强合权限，更容易让Maintainer在一些自认为不关键的问题上（如单元测试）放松管制，使得自动化质量管控机制形同虚设。

## 如何改进

这块儿在互联网公司基本经过多年的迭代，几乎所有的公司基本上都走向了如下的代码仓库管理模式，应该可以直接借鉴过来：

1. 将Review职责下放到一些有经验的研发者，而不是集中在Maintainer
Reviewer需要完成两类Review工作，一是代码质量与规范类检查 ，二是一些本应自动化进行，但暂自动化困难，需要人工检查的东西（如是否有贴一个regression报告上来），如果完成了以上检查则可以对代码进行review +1操作。

未检查regression报告而后续发生regression问题的，reviewer应一并担责。
后续可能应考虑对regression进行更进一步的自动化检查流程，降低未检查regression报告导致问题的概率。
前期，Reviewer人员可以由各个方向负责人指定一些，后续应有一个完整的Qualified Reviewer认证机制。

2. 将流水线通过且Review通过的MR合入权限与责任下放至提交者自己
因为流水线有时可能需要多次修复能通过，让其他任何人来为提交者的流水线通过进行检查都将会可能会带来多轮来回交互，大大降低了整个流程的效率。而流水线通过且Review过的MR一般质量已经足够合入，将合入权限下放给任何人都不会降低代码库质量。甚至因为一般人无强合权限，可能可以使得强合概率大大下降。

## Gitlab上实现前述新流程
当前遇到一些问题：
- 如果开启流水线必须成功，则Maintainer也无法强合，导致经常需要持续不断的rebase，合入成本过高。
- 如果关闭流水线必须成功，则所有人都能跳过流水线强行合入。
如何才能做到流水线通过时，所有人都可以合入。流水线不通过时，只有maintainer才可以合入？





